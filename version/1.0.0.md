# AzerothCore éšæœºå±æ€§ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ï¿½ï¿½ ç³»ç»Ÿæ¦‚è¿°

### ç›®æ ‡
ä¸ºAzerothCore WotLKæœåŠ¡å™¨æ·»åŠ è£…å¤‡éšæœºå±æ€§ç³»ç»Ÿï¼Œè®©ç‰¹å®šæ¥æºçš„è£…å¤‡ï¼ˆä»ä¼˜ç§€å“è´¨å¼€å§‹ï¼‰éšæœºè·å¾—1-5æ¡é™„åŠ å±æ€§ï¼Œå¢åŠ æ¸¸æˆçš„è¶£å‘³æ€§å’Œè£…å¤‡æ”¶é›†ä»·å€¼ã€‚

### å±æ€§åˆ†é…è§„åˆ™
- **æ™®é€šè£…å¤‡** (ITEM_QUALITY_POOR)ï¼š0æ¡éšæœºå±æ€§
- **ä¼˜ç§€è£…å¤‡** (ITEM_QUALITY_UNCOMMON)ï¼š0-1æ¡éšæœºå±æ€§  
- **ç²¾è‰¯è£…å¤‡** (ITEM_QUALITY_RARE)ï¼š0-2æ¡éšæœºå±æ€§
- **å²è¯—è£…å¤‡** (ITEM_QUALITY_EPIC)ï¼š1-3æ¡éšæœºå±æ€§
- **ä¼ è¯´è£…å¤‡** (ITEM_QUALITY_LEGENDARY)ï¼š2-5æ¡éšæœºå±æ€§

## ğŸ¯ è§¦å‘æ—¶æœº

### å‚ä¸éšæœºå±æ€§çš„è£…å¤‡æ¥æº
- **æ€ªç‰©æ‰è½è£…å¤‡** - ç”Ÿæˆéšæœºå±æ€§
- **ä»»åŠ¡å¥–åŠ±è£…å¤‡** - ç”Ÿæˆéšæœºå±æ€§  
- **å‰¯æœ¬å®ç®±è£…å¤‡** - ç”Ÿæˆéšæœºå±æ€§
- **ä¸–ç•Œäº‹ä»¶å¥–åŠ±è£…å¤‡** - ç”Ÿæˆéšæœºå±æ€§
- **åˆ¶é€ è£…å¤‡** - ç”Ÿæˆéšæœºå±æ€§
- **å…¶ä»–éé‚®ä»¶ã€éå•†äººçš„è£…å¤‡æ¥æº** - ç”Ÿæˆéšæœºå±æ€§

### ä¸å‚ä¸éšæœºå±æ€§çš„è£…å¤‡æ¥æº
- **é‚®ä»¶è·å¾—çš„è£…å¤‡** - ä¿æŒåŸæ ·ï¼Œä¸æ·»åŠ éšæœºå±æ€§
- **å•†äººå”®å–çš„è£…å¤‡** - ä¿æŒåŸæ ·ï¼Œä¸æ·»åŠ éšæœºå±æ€§

### è§¦å‘æ¡ä»¶
1. è£…å¤‡å“è´¨ â‰¥ ä¼˜ç§€ (ITEM_QUALITY_UNCOMMON)
2. è£…å¤‡ç±»å‹ä¸ºæ­¦å™¨æˆ–æŠ¤ç”²ç±»
3. è£…å¤‡æ¥æºä¸åœ¨æ’é™¤åˆ—è¡¨ä¸­

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. éšæœºå±æ€§è¡¨
```sql
CREATE TABLE `item_random_attributes` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `item_guid` bigint unsigned NOT NULL,
  `attribute_type` tinyint unsigned NOT NULL,
  `attribute_value` int NOT NULL,
  `attribute_quality` tinyint unsigned NOT NULL DEFAULT 1,
  `random_multiplier` float NOT NULL DEFAULT 1.0,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `item_guid_attribute` (`item_guid`, `attribute_type`),
  KEY `idx_item_guid` (`item_guid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Item Random Attributes System';
```

### 2. å±æ€§ç±»å‹å®šä¹‰è¡¨
```sql
CREATE TABLE `item_attribute_types` (
  `id` tinyint unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL,
  `display_name` varchar(100) NOT NULL,
  `category` tinyint unsigned NOT NULL DEFAULT 1,
  `base_multiplier` float NOT NULL DEFAULT 1.0,
  `quality_multiplier` float NOT NULL DEFAULT 1.0,
  `min_quality` tinyint unsigned NOT NULL DEFAULT 2,
  `max_quality` tinyint unsigned NOT NULL DEFAULT 5,
  `weight` int unsigned NOT NULL DEFAULT 100,
  `enabled` tinyint unsigned NOT NULL DEFAULT 1,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Item Attribute Types Definition';
```

## ï¿½ï¿½ å±æ€§ç±»å‹å®šä¹‰

### åŸºç¡€å±æ€§ (ç‰©å“ç­‰çº§ Ã— 0.33 Ã— 0.5-1.5)
```sql
INSERT INTO `item_attribute_types` VALUES
(1, 'STRENGTH', 'åŠ›é‡', 1, 0.33, 1.0, 2, 5, 100, 1),
(2, 'AGILITY', 'æ•æ·', 1, 0.33, 1.0, 2, 5, 100, 1),
(3, 'STAMINA', 'è€åŠ›', 1, 0.33, 1.0, 2, 5, 100, 1),
(4, 'SPIRIT', 'ç²¾ç¥', 1, 0.33, 1.0, 2, 5, 100, 1),
(5, 'INTELLECT', 'æ™ºåŠ›', 1, 0.33, 1.0, 2, 5, 100, 1);
```

### ä¼¤å®³å±æ€§ (ç‰©å“ç­‰çº§ Ã— 0.5 Ã— 0.5-1.5)
```sql
INSERT INTO `item_attribute_types` VALUES
(6, 'FIRE_DAMAGE', 'ç«ç„°ä¼¤å®³', 2, 0.5, 1.0, 2, 5, 80, 1),
(7, 'SHADOW_DAMAGE', 'æš—å½±ä¼¤å®³', 2, 0.5, 1.0, 2, 5, 80, 1),
(8, 'HOLY_DAMAGE', 'ç¥åœ£ä¼¤å®³', 2, 0.5, 1.0, 2, 5, 80, 1),
(9, 'FROST_DAMAGE', 'å†°éœœä¼¤å®³', 2, 0.5, 1.0, 2, 5, 80, 1),
(10, 'NATURE_DAMAGE', 'è‡ªç„¶ä¼¤å®³', 2, 0.5, 1.0, 2, 5, 80, 1),
(11, 'ARCANE_DAMAGE', 'å¥¥æœ¯ä¼¤å®³', 2, 0.5, 1.0, 2, 5, 80, 1);
```

### é˜²å¾¡å±æ€§ (ç‰©å“ç­‰çº§ Ã— 0.3 Ã— 0.5-1.5)
```sql
INSERT INTO `item_attribute_types` VALUES
(12, 'DEFENSE_RATING', 'é˜²å¾¡ç­‰çº§', 3, 0.3, 1.0, 2, 5, 60, 1),
(13, 'DODGE_RATING', 'é—ªé¿ç­‰çº§', 3, 0.3, 1.0, 2, 5, 60, 1),
(14, 'BLOCK_RATING', 'æ ¼æŒ¡ç­‰çº§', 3, 0.3, 1.0, 2, 5, 60, 1),
(15, 'PARRY_RATING', 'æ‹›æ¶ç­‰çº§', 3, 0.3, 1.0, 2, 5, 60, 1),
(16, 'ARMOR', 'æŠ¤ç”²å€¼', 3, 2.0, 1.0, 2, 5, 60, 1);
```

### æ”»å‡»å±æ€§ (ç‰©å“ç­‰çº§ Ã— 0.3 Ã— 0.5-1.5)
```sql
INSERT INTO `item_attribute_types` VALUES
(17, 'HIT_RATING', 'å‘½ä¸­ç­‰çº§', 4, 0.3, 1.0, 2, 5, 70, 1),
(18, 'CRIT_RATING', 'æš´å‡»ç­‰çº§', 4, 0.3, 1.0, 2, 5, 70, 1),
(19, 'HASTE_RATING', 'æ€¥é€Ÿç­‰çº§', 4, 0.3, 1.0, 2, 5, 70, 1),
(20, 'EXPERTISE_RATING', 'ç²¾å‡†ç­‰çº§', 4, 0.3, 1.0, 2, 5, 70, 1),
(21, 'PENETRATION_RATING', 'ç©¿é€ç­‰çº§', 4, 0.3, 1.0, 2, 5, 70, 1);
```

### æ³•æœ¯å±æ€§ (ç‰©å“ç­‰çº§ Ã— 0.3 Ã— 0.5-1.5)
```sql
INSERT INTO `item_attribute_types` VALUES
(22, 'SPELL_HIT', 'æ³•æœ¯å‘½ä¸­', 5, 0.3, 1.0, 2, 5, 50, 1),
(23, 'SPELL_CRIT', 'æ³•æœ¯æš´å‡»', 5, 0.3, 1.0, 2, 5, 50, 1),
(24, 'SPELL_HASTE', 'æ³•æœ¯æ€¥é€Ÿ', 5, 0.3, 1.0, 2, 5, 50, 1),
(25, 'SPELL_PENETRATION', 'æ³•æœ¯ç©¿é€', 5, 0.3, 1.0, 2, 5, 50, 1),
(26, 'SPELL_POWER', 'æ³•æœ¯å¼ºåº¦', 5, 0.3, 1.0, 2, 5, 50, 1);
```

### æ¢å¤å±æ€§ (ç‰©å“ç­‰çº§ Ã— 0.33 Ã— 0.5-1.5)
```sql
INSERT INTO `item_attribute_types` VALUES
(27, 'HEALTH_REGEN', 'ç”Ÿå‘½å›å¤', 6, 0.33, 1.0, 2, 5, 30, 1);
```

### ç‰¹æ®Šå±æ€§ (ç§»åŠ¨é€Ÿåº¦å›ºå®š1-3%)
```sql
INSERT INTO `item_attribute_types` VALUES
(28, 'MOVEMENT_SPEED', 'ç§»åŠ¨é€Ÿåº¦', 7, 0.0, 1.0, 2, 5, 20, 1);
```

## ğŸ’» C++ å®ç°æ–¹æ¡ˆ

### 1. ç‰©å“æ¥æºç±»å‹å®šä¹‰
```cpp
enum ItemSourceType
{
    ITEM_SOURCE_LOOT = 1,      // æ€ªç‰©æ‰è½
    ITEM_SOURCE_QUEST = 2,     // ä»»åŠ¡å¥–åŠ±
    ITEM_SOURCE_VENDOR = 3,    // å•†äººå”®å–
    ITEM_SOURCE_MAIL = 4,      // é‚®ä»¶è·å¾—
    ITEM_SOURCE_CHEST = 5,     // å®ç®±
    ITEM_SOURCE_EVENT = 6,     // äº‹ä»¶å¥–åŠ±
    ITEM_SOURCE_CRAFT = 7,     // åˆ¶é€ 
    ITEM_SOURCE_OTHER = 8      // å…¶ä»–æ¥æº
};
```

### 2. å¤´æ–‡ä»¶ `ItemRandomAttributes.h`
```cpp
#ifndef ITEM_RANDOM_ATTRIBUTES_H
#define ITEM_RANDOM_ATTRIBUTES_H

#include "Common.h"
#include "DatabaseEnv.h"
#include "ItemTemplate.h"

struct ItemAttributeType
{
    uint8 id;
    std::string name;
    std::string displayName;
    uint8 category;
    float baseMultiplier;
    float qualityMultiplier;
    uint8 minQuality;
    uint8 maxQuality;
    uint32 weight;
    bool enabled;
};

struct ItemRandomAttribute
{
    uint32 id;
    ObjectGuid::LowType itemGuid;
    uint8 attributeType;
    int32 attributeValue;
    uint8 attributeQuality;
    float randomMultiplier;
    time_t createdAt;
};

class ItemRandomAttributesMgr
{
public:
    static ItemRandomAttributesMgr* instance();
    
    void LoadAttributeTypes();
    void LoadItemAttributes();
    
    bool GenerateRandomAttributes(Item* item);
    std::vector<ItemRandomAttribute> GetItemAttributes(ObjectGuid::LowType itemGuid);
    void SaveItemAttribute(const ItemRandomAttribute& attr);
    void DeleteItemAttributes(ObjectGuid::LowType itemGuid);
    
    std::string GetAttributeDisplayText(const ItemRandomAttribute& attr);
    int32 CalculateAttributeValue(uint8 attributeType, uint32 itemLevel, uint8 itemQuality);
    bool ShouldGenerateRandomAttributes(Item* item, uint32 sourceType);

private:
    std::unordered_map<uint8, ItemAttributeType> _attributeTypes;
    std::unordered_map<ObjectGuid::LowType, std::vector<ItemRandomAttribute>> _itemAttributes;
    
    uint8 GetRandomAttributeCount(uint8 itemQuality);
    uint8 SelectRandomAttributeType(uint8 itemQuality, uint8 itemClass, uint8 itemSubClass);
    bool IsAttributeCompatible(uint8 attributeType, uint8 itemClass, uint8 itemSubClass);
};

#define sItemRandomAttributesMgr ItemRandomAttributesMgr::instance()

#endif
```

### 3. æ ¸å¿ƒå®ç°å‡½æ•°
```cpp
bool ItemRandomAttributesMgr::ShouldGenerateRandomAttributes(Item* item, uint32 sourceType)
{
    if (!item)
        return false;
        
    ItemTemplate const* proto = item->GetTemplate();
    if (!proto)
        return false;
        
    // åªæœ‰è£…å¤‡ç±»ç‰©å“æ‰èƒ½æœ‰éšæœºå±æ€§
    if (proto->Class != ITEM_CLASS_ARMOR && proto->Class != ITEM_CLASS_WEAPON)
        return false;
        
    // æ’é™¤é‚®ä»¶å’Œå•†äººæ¥æºçš„è£…å¤‡
    switch (sourceType)
    {
        case ITEM_SOURCE_MAIL:        // é‚®ä»¶æ¥æº
        case ITEM_SOURCE_VENDOR:      // å•†äººæ¥æº
            return false;
        case ITEM_SOURCE_LOOT:        // æ€ªç‰©æ‰è½
        case ITEM_SOURCE_QUEST:       // ä»»åŠ¡å¥–åŠ±
        case ITEM_SOURCE_CHEST:       // å®ç®±
        case ITEM_SOURCE_EVENT:       // äº‹ä»¶å¥–åŠ±
        case ITEM_SOURCE_CRAFT:       // åˆ¶é€ 
        default:
            return true;
    }
}

int32 ItemRandomAttributesMgr::CalculateAttributeValue(uint8 attributeType, uint32 itemLevel, uint8 itemQuality)
{
    auto it = _attributeTypes.find(attributeType);
    if (it == _attributeTypes.end())
        return 0;
        
    ItemAttributeType const& attrType = it->second;
    
    // ç‰¹æ®Šå¤„ç†ç§»åŠ¨é€Ÿåº¦å±æ€§
    if (attrType.name == "MOVEMENT_SPEED")
    {
        // ç§»åŠ¨é€Ÿåº¦å›ºå®šä¸º1-3%
        float randomPercent = frand(1.0f, 3.0f);
        return int32(randomPercent * 100); // è½¬æ¢ä¸ºæ•´æ•°ç™¾åˆ†æ¯”
    }
    
    // å…¶ä»–å±æ€§çš„æ­£å¸¸è®¡ç®—
    float baseValue = itemLevel * attrType.baseMultiplier;
    float qualityBonus = (itemQuality - 1) * attrType.qualityMultiplier;
    float totalBaseValue = baseValue + qualityBonus;
    
    // ç”Ÿæˆ0.5-1.5å€çš„éšæœºå€æ•°
    float randomMultiplier = frand(0.5f, 1.5f);
    
    // åº”ç”¨éšæœºå€æ•°
    float finalValue = totalBaseValue * randomMultiplier;
    
    return int32(finalValue);
}
```

## âš™ï¸ é…ç½®é€‰é¡¹

### worldserver.conf é…ç½®
```ini
[ItemRandomAttributes]
# å¯ç”¨éšæœºå±æ€§ç³»ç»Ÿ
Enabled = 1

# éšæœºå€æ•°èŒƒå›´
RandomMultiplierMin = 0.5
RandomMultiplierMax = 1.5

# æ˜¯å¦å¯ç”¨å°æ•°ç‚¹æ˜¾ç¤º
ShowDecimals = 0

# å±æ€§å€¼å››èˆäº”å…¥
RoundToNearest = 1

# å±æ€§ç”Ÿæˆæ¦‚ç‡è°ƒæ•´
AttributeChanceMultiplier = 1.0

# å±æ€§å€¼è°ƒæ•´
AttributeValueMultiplier = 1.0

# æœ€å¤§å±æ€§æ•°é‡é™åˆ¶
MaxAttributesPerItem = 5
```

## ï¿½ï¿½ å®é™…æ•ˆæœç¤ºä¾‹

### ç‰©å“ç­‰çº§80çš„å²è¯—è£…å¤‡ç¤ºä¾‹

#### ä¼˜ç§€éšæœºå±æ€§ (0.5å€)
- åŠ›é‡ +13 (80 Ã— 0.33 Ã— 0.5)
- ç«ç„°ä¼¤å®³ +20 (80 Ã— 0.5 Ã— 0.5)
- é˜²å¾¡ç­‰çº§ +12 (80 Ã— 0.3 Ã— 0.5)
- ç§»åŠ¨é€Ÿåº¦ +1.5%

#### æ™®é€šéšæœºå±æ€§ (1.0å€)
- åŠ›é‡ +26 (80 Ã— 0.33 Ã— 1.0)
- ç«ç„°ä¼¤å®³ +40 (80 Ã— 0.5 Ã— 1.0)
- é˜²å¾¡ç­‰çº§ +24 (80 Ã— 0.3 Ã— 1.0)
- ç§»åŠ¨é€Ÿåº¦ +2.0%

#### æå“éšæœºå±æ€§ (1.5å€)
- åŠ›é‡ +40 (80 Ã— 0.33 Ã— 1.5)
- ç«ç„°ä¼¤å®³ +60 (80 Ã— 0.5 Ã— 1.5)
- é˜²å¾¡ç­‰çº§ +36 (80 Ã— 0.3 Ã— 1.5)
- ç§»åŠ¨é€Ÿåº¦ +2.8%

## âš–ï¸ å¹³è¡¡æ€§åˆ†æ

### å±æ€§å€¼èŒƒå›´å¯¹æ¯”
| å±æ€§ç±»å‹ | ç‰©å“ç­‰çº§100èŒƒå›´ | ä¸ç°æœ‰è£…å¤‡å¯¹æ¯” |
|---------|----------------|---------------|
| åŸºç¡€å±æ€§ | 17-50ç‚¹ | çº¦1ä¸ªå®çŸ³çš„åŠ æˆ |
| ä¼¤å®³å±æ€§ | 25-75ç‚¹ | é€‚åº¦çš„é¢å¤–ä¼¤å®³ |
| é˜²å¾¡å±æ€§ | 15-45ç‚¹ | é€‚åº¦çš„é˜²å¾¡åŠ æˆ |
| æ”»å‡»å±æ€§ | 15-45ç‚¹ | é€‚åº¦çš„å‘½ä¸­/æš´å‡»åŠ æˆ |
| æ³•æœ¯å±æ€§ | 15-45ç‚¹ | é€‚åº¦çš„æ³•æœ¯åŠ æˆ |
| æ¢å¤å±æ€§ | 17-50ç‚¹ | é€‚åº¦çš„æ¢å¤åŠ æˆ |
| ç§»åŠ¨é€Ÿåº¦ | 1-3% | å¾ˆæœ‰ä»·å€¼çš„ç‰¹æ®Šå±æ€§ |

### å¹³è¡¡æ€§ç‰¹ç‚¹
1. **æœ€ä½ä¿è¯**ï¼š0.5å€ç¡®ä¿å±æ€§ä¸ä¼šå¤ªä½
2. **æœ€é«˜é™åˆ¶**ï¼š1.5å€é˜²æ­¢å±æ€§è¿‡äºå¼ºå¤§
3. **å¹³å‡æœŸæœ›**ï¼š1.0å€ä¿æŒæ•´ä½“å¹³è¡¡
4. **å“è´¨å½±å“**ï¼šé«˜å“è´¨è£…å¤‡ä»ç„¶æœ‰æ›´å¤šå±æ€§æ¡æ•°
5. **ç§»åŠ¨é€Ÿåº¦**ï¼šå›ºå®šç™¾åˆ†æ¯”ï¼Œä¸å—ç‰©å“ç­‰çº§å½±å“

### è®¾è®¡ä¼˜åŠ¿
1. **ä¿æŒå•†äººè£…å¤‡ç¨³å®šæ€§** - ç©å®¶å¯ä»¥ä¹°åˆ°ç¡®å®šå±æ€§çš„è£…å¤‡
2. **é¿å…é‚®ä»¶è£…å¤‡éšæœºæ€§** - é‚®ä»¶è£…å¤‡ä¿æŒåŸæœ‰å±æ€§
3. **å¢åŠ å†’é™©å¥–åŠ±ä»·å€¼** - åªæœ‰é€šè¿‡å†’é™©è·å¾—çš„è£…å¤‡æ‰æœ‰éšæœºå±æ€§
4. **ä¿æŒæ¸¸æˆå¹³è¡¡** - ä¸ä¼šå½±å“ç°æœ‰çš„è£…å¤‡è·å–æœºåˆ¶

## ï¿½ï¿½ å®ç°æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“å‡†å¤‡
1. åˆ›å»ºæ•°æ®åº“è¡¨
2. æ’å…¥å±æ€§ç±»å‹æ•°æ®
3. æµ‹è¯•æ•°æ®åº“è¿æ¥

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½
1. å®ç° ItemRandomAttributesMgr ç±»
2. å®ç°å±æ€§ç”Ÿæˆé€»è¾‘
3. å®ç°å±æ€§æ˜¾ç¤ºåŠŸèƒ½

### ç¬¬ä¸‰é˜¶æ®µï¼šé›†æˆæµ‹è¯•
1. ä¿®æ”¹ç‰©å“åˆ›å»ºé€»è¾‘
2. ä¿®æ”¹ç‰©å“æ˜¾ç¤ºé€»è¾‘
3. æµ‹è¯•éšæœºå±æ€§ç”Ÿæˆ

### ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–å®Œå–„
1. æ·»åŠ é…ç½®é€‰é¡¹
2. ä¼˜åŒ–æ€§èƒ½
3. æ·»åŠ ç®¡ç†å‘½ä»¤

## âœ… å¾…åŠäº‹é¡¹

- [ ] åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„
- [ ] å®ç°æ ¸å¿ƒC++ç±»
- [ ] é›†æˆåˆ°ç‰©å“ç³»ç»Ÿ
- [ ] æ·»åŠ é…ç½®é€‰é¡¹
- [ ] æµ‹è¯•å’Œè°ƒè¯•
- [ ] æ·»åŠ ç®¡ç†å‘½ä»¤
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2024å¹´12æœˆ19æ—¥  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ19æ—¥  
**çŠ¶æ€**: è®¾è®¡å®Œæˆï¼Œå¾…å®ç°